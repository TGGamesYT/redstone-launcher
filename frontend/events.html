<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Redstone Launcher - Events</title>
  <link rel="stylesheet" href="server.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>
<div id="toolbar">
<div class="drag-region">Redstone Launcher</div>
<div class="toolbar-buttons">
    <button id="min-btn">—</button>
    <button id="max-btn">□</button>
    <button id="close-btn">✕</button>
</div>
</div>
<div class="sidebar">
  <!-- Top section -->
  <ul class="menu top">
    <li><a href="index.html"><i class="material-icons">home</i></a><span>Home</span></li>
    <li><a href="instances.html"><i class="material-icons">play_arrow</i></a><span>Play</span></li>
    <li><a href="modrinth.html"><img src="https://tggamesyt.dev/assets/modrinth_icon.png" style="width: 24px;"></a><span>Modrinth</span></li>
    <li><a href="server.html"><i class="material-icons">storage</i></a><span>Server Manager</span></li>
    <li><a href="settings.html"><i class="material-icons">settings</i></a><span>Settings</span></li>
    <li><a href="players.html"><i class="material-icons">person</i></a><span>Profiles</span></li>
    <li><a href="profile-manager.html"><i class="material-icons">face</i></a><span>Skin, cape changer</span></li>
  </ul>

  <!-- Middle section (instances) -->
  <ul class="menu middle" id="instances">
    <li><i class="material-icons">add</i><span>Add an instance</span></li>
  </ul>

  <!-- Bottom section -->
  <ul class="menu bottom">
    <li><i class="material-icons">download</i><span>Download the latest update</span></li>
    <li id="players-login"><a href="players.html"><i class="material-icons">login</i></a><span>Login</span></li>
    <li><i class="material-icons" onclick="closeApp()">exit_to_app</i><span>Exit the launcher</span></li>
  </ul>
</div>

  <h1>Events</h1>

 <div class="panel">
  <div id="players-section">
    <label>Select Player:</label>
    <select id="playerSelect"></select>
  </div>

  <h2>Ongoing Events</h2>
  <div id="ongoing" class="event-list"></div>

  <h2>Upcoming Events</h2>
  <div id="upcoming" class="event-list"></div>

  <h2>Previous Events</h2>
  <div id="previous" class="event-list"></div>

  <script>
    const { ipcRenderer } = require('electron');
    const https = require('https');

    let selectedPlayerId = null;
    let events = [];

    // Load players
    ipcRenderer.send('get-players');
    ipcRenderer.on('players-list', (event, players) => {
      const select = document.getElementById('playerSelect');
      select.innerHTML = '<option value="">-- Select Player --</option>';
      players.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        const displayName = p.type === "microsoft" ? (p.auth?.name ?? "MS Account") : (p.username ?? "Cracked");
        opt.textContent = `[${p.type}] ${displayName}`;
        select.appendChild(opt);
      });

      select.addEventListener('change', () => {
        selectedPlayerId = Number(select.value);
      });
    });

    // Fetch events JSON directly
    function fetchEventsJson(url) {
      return new Promise((resolve, reject) => {
        https.get(url, res => {
          let data = '';
          res.on('data', chunk => data += chunk);
          res.on('end', () => {
            try { resolve(JSON.parse(data)); }
            catch (err) { reject(err); }
          });
        }).on('error', err => reject(err));
      });
    }

    // Helper to parse date
    function parseDate(str) { return new Date(str + "T00:00:00"); }

    // Render events
    function renderEvents() {
      const ongoingDiv = document.getElementById('ongoing');
      const upcomingDiv = document.getElementById('upcoming');
      const previousDiv = document.getElementById('previous');

      ongoingDiv.innerHTML = '';
      upcomingDiv.innerHTML = '';
      previousDiv.innerHTML = '';

      const now = new Date();

      events.forEach(ev => {
        const start = parseDate(ev.start);
        const end = parseDate(ev.end);

        let container;
        if (now >= start && now <= end) container = ongoingDiv;
        else if (now < start) container = upcomingDiv;
        else container = previousDiv;

        const div = document.createElement('div');
        div.className = 'event-item';

        const btn = document.createElement('button');
        btn.textContent = ev.name;

        // Only disable if not in ongoing
        if (container !== ongoingDiv) btn.classList.add('disabled');

        btn.onclick = async () => {
          if (container !== ongoingDiv) return;
          if (!selectedPlayerId) { alert("Select a player first!"); return; }

          try {
            const result = await ipcRenderer.invoke("handle-mrpack-quickplay", {
              accountId: selectedPlayerId,
              serverIp: ev.serverIp,
              mrpackUrl: ev.mrpackUrl
            });
            if (!result.success) alert("Failed: " + result.error);
          } catch (err) {
            alert("Error: " + err.message);
          }
        };

        div.appendChild(btn);

        const dateSpan = document.createElement('span');
        dateSpan.className = 'event-date';
        dateSpan.textContent = `(${ev.start} → ${ev.end})`;
        div.appendChild(dateSpan);

        container.appendChild(div);
      });

    }

    // Fetch and render events
    (async () => {
      try {
        events = await fetchEventsJson('https://tggamesyt.dev/redstone-launcher/events.json');
        renderEvents();
      } catch (err) {
        alert("Failed to fetch events: " + err.message);
      }
    })();
  </script>
  </div>
</body>

</html>