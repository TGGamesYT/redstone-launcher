<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Redstone Launcher - Player Manager</title>
  <link rel="stylesheet" href="server.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Container around canvas + card panels */
#content-wrapper {
  display: flex;
  flex-direction: row;
  margin-top: 20px;
}

/* Canvas on the left */
#skin_container {
  flex: 0 0 auto;
  margin-right: 20px;
  border-radius: var(--border-radius);
}

/* Cards column on the right */
#cards-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 20px;
  max-height: calc(100vh - 38px);
  overflow-y: auto;
}

/* Group label (Skins / Capes headers) */
.cards-header {
  color: var(--text-color);
  font-size: 20px;
  margin-bottom: 6px;
}

/* Holder for skins and capes */
#skins, #capes {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
    .card {
  width: 160px;
  background: var(--base-color);
  border-radius: var(--border-radius);
  margin: 10px;
  padding: 8px;
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  display: inline-block;
  text-align: center;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.card-image {
  width: 100%;
  border-radius: var(--border-radius);
}

.card-label {
  color: var(--text-color);
  margin-top: 6px;
  font-size: 14px;
}

  </style>
</head>
<body>
<div id="toolbar">
  <div class="toolbar-buttons-left">
      <button id="backBtn">⬅</button>
      <button id="forwardBtn">➡</button>
  </div>
<div class="drag-region">Redstone Launcher</div>
<div class="toolbar-buttons">
    <div id="instance-processes"></div>
    <button id="min-btn">—</button>
    <button id="max-btn">◻</button>
    <button id="close-btn">✕</button>
</div>
</div>
<div class="sidebar">
  <ul class="menu top">
    <a href="index.html"><li><i class="material-icons">home</i><span>Home</span></li></a>
    <a href="instances.html"><li><i class="material-icons">play_arrow</i><span>Instances</span></li></a>
    <a href="modrinth.html" class="modrinth"><li><span>Modrinth</span></li></a>
    <a href="server.html"><li><i class="material-icons">storage</i><span>Server Manager</span></li></a>
  </ul>
  <ul class="menu middle" id="instances">
    <li><i class="material-icons">add</i><span>Add an instance</span></li>
  </ul>
  <ul class="menu bottom">
    <li id="update"><i class="material-icons">download</i><span id="updateText">Download the latest update</span></li>
    <li><a href="profile-manager.html"><i class="material-icons">face</i></a><span>Skin, cape changer</span></li>
    <a href="players.html"><li id="players-login"><i class="material-icons">login</i><span>Login</span></li></a>
    <li><a href="settings.html"><i class="material-icons">settings</i></a><span>Settings</span></li>
  </ul>
</div>
<div id="content-wrapper">

  <canvas id="skin_container"></canvas>
  <img id="myImage" style="display: none;" />
  <div id="cards-column">
    <div>
      <div class="cards-header">Skins</div>
      <div id="skins"></div>
    </div>

    <div>
      <div class="cards-header">Capes</div>
      <div id="capes"></div>
    </div>
  </div>

</div>
<script src="skinview3d.bundle.js"></script>
<script>
players = [];
      const { ipcRenderer } = require('electron');
      async function getSelectedPlayer() {return await ipcRenderer.invoke('get-selected-player')}
      let selectedplayer;

  async function updateSKin() {
    selectedplayer = await getSelectedPlayer();
    let player = players.find(p => p.id === selectedplayer);
    let name;
    if (!player.auth || !player.auth.name) {
      name = player.username;
    } else {
      name = player.auth.name;
    }
    if (skinview3d === null) {
      let canvas = document.getElementById('skin_container');
      const ctx = canvas.getContext('2d');

      const img = new Image();
      img.src = `https://starlightskins.lunareclipse.studio/render/ultimate/${name}/full`;

      img.onload = function() {
        // Once the image is loaded, set the canvas size to the image size:
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;

        // Draw the image on the canvas:
        ctx.drawImage(img, 0, 0);
      };
      return;
    } else {
    skinViewer = new skinview3d.SkinViewer({
      canvas: document.getElementById("skin_container"),
      skin: `https://minotar.net/skin/${name}`,
      width: 600,
      height: 800
    });
    const res = await fetch(`https://api.capes.dev/load/${encodeURIComponent(name)}`);
    if (!res.ok) {
      throw new Error(`API error: ${res.status}`);
    }
  
    const data = await res.json();
    
    skinViewer.loadCape(data?.minecraft?.imageUrl || null);
  }
  return;
  }
    ipcRenderer.send("get-players");
  ipcRenderer.on("players-list", (event, newPlayers) => { players = newPlayers; updateSKin(); });
  ipcRenderer.on("players-updated", (event, newPlayers) => { players = newPlayers; updateSKin(); });
function updatePresence(details, state = "Idle") {
  ipcRenderer.send('update-discord-presence', { details, state });
}

(async () => {
  let player = players.find(p => p.id === selectedplayer);
  if (player?.type != "cracked") {
  const profile = await ipcRenderer.invoke("mc:getProfile");
  const skinsDiv = document.getElementById("skins");
  const capesDiv = document.getElementById("capes");

  // A tiny helper to create a card
  function createCard(imgUrl, label, onClick) {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.src = imgUrl;
    img.className = "card-image";

    card.appendChild(img);

    card.onclick = onClick;
    return card;
  }

  // ---- Current skins ----
  profile.skins.forEach(skin => {
    const displayName = skin.alias || skin.id;

    const imgUrl =
      `https://starlightskins.lunareclipse.studio/render/ultimate/notch/bust?skinUrl=${encodeURIComponent(skin.url)}`;

    const card = createCard(
      imgUrl,
      `Skin: ${displayName}`,
      () => ipcRenderer.invoke("mc:applySkin", skin)
          .catch(err => console.error("skin fail:", err))
    );

    skinsDiv.appendChild(card);
  });

  // ---- Current capes ----
  profile.capes.forEach(cape => {
    const displayName = cape.alias || cape.id;
    let player = players.find(p => p.id === selectedplayer);
    const imgUrl =
      `https://starlightskins.lunareclipse.studio/render/ultimate/${player.username}/bust` +
      `?cameraPosition=%7B"x"%3A"0"%2C"y"%3A"20"%2C"z"%3A"35"%7D&cameraFocalPoint=%20%7B"x"%3A"0"%2C"y"%3A"10"%2C"z"%3A"0"%7D&dirLightPos=%7B"x"%3A"10"%2C"y"%3A"10"%2C"z"%3A"10"%7D&cameraWidth=250&cameraHeight=600&cameraFOV=50` +
      `&capeTexture=${encodeURIComponent(cape.url)}`;

    const card = createCard(
      imgUrl,
      `Cape: ${displayName}`,
      () => ipcRenderer.invoke("mc:applyCape", cape.id)
          .catch(err => console.error("cape fail:", err))
    );

    capesDiv.appendChild(card);
  });
} else {
  document.getElementById('cards-column').style.display = "none";
  document.getElementById("content-wrapper").append("Skin Changing isnt available for cracked players");
}
})();



updatePresence("Managing skins")
</script>
  <script src="sidebar.js"></script>
  </div>
</body>
</html>
