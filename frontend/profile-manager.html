<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Redstone Launcher - Player Manager</title>
  <link rel="stylesheet" href="server.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<div id="toolbar">
  <div class="toolbar-buttons-left">
      <button id="backBtn">⬅</button>
      <button id="forwardBtn">➡</button>
  </div>
<div class="drag-region">Redstone Launcher</div>
<div class="toolbar-buttons">
    <div id="instance-processes"></div>
    <button id="min-btn">—</button>
    <button id="max-btn">◻</button>
    <button id="close-btn">✕</button>
</div>
</div>
<div class="sidebar">
  <ul class="menu top">
    <a href="index.html"><li><i class="material-icons">home</i><span>Home</span></li></a>
    <a href="instances.html"><li><i class="material-icons">play_arrow</i><span>Instances</span></li></a>
    <a href="modrinth.html" class="modrinth"><li><span>Modrinth</span></li></a>
    <a href="server.html"><li><i class="material-icons">storage</i><span>Server Manager</span></li></a>
  </ul>
  <ul class="menu middle" id="instances">
    <li><i class="material-icons">add</i><span>Add an instance</span></li>
  </ul>
  <ul class="menu bottom">
    <li id="update"><i class="material-icons">download</i><span id="updateText">Download the latest update</span></li>
    <li><a href="profile-manager.html"><i class="material-icons">face</i></a><span>Skin, cape changer</span></li>
    <a href="players.html"><li id="players-login"><i class="material-icons">login</i><span>Login</span></li></a>
    <li><a href="settings.html"><i class="material-icons">settings</i></a><span>Settings</span></li>
  </ul>
</div>
<canvas id="skin_container"></canvas>
<img id="myImage" style="display: none;" />
<div id="skins"></div>
<div id="capes"></div>

<script>
players = [];
      const { ipcRenderer } = require('electron');
      async function getSelectedPlayer() {return await ipcRenderer.invoke('get-selected-player')}
      const skinview3d = require("skinview3d");
      let selectedplayer;

  async function updateSKin() {
    selectedplayer = await getSelectedPlayer();
    if (skinview3d === null) {
      let canvas = document.getElementById('skin_container');
      const ctx = canvas.getContext('2d');

      const img = new Image();
      img.src = 'path/to/your/image.jpg';

      img.onload = function() {
        // Once the image is loaded, set the canvas size to the image size:
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;

        // Draw the image on the canvas:
        ctx.drawImage(img, 0, 0);
      };
      return;
    }
    const player = players.find(p => p.id === selectedPlayerId);
    let name;
    if (!player.auth || !player.auth.name) {
      name = player.username;
    } else {
      name = player.auth.name;
    }
    skinViewer = new skinview3d.SkinViewer({
      canvas: document.getElementById("skin_container"),
      skin: `https://minotar.net/skin/${name}`,
      width: 600,
      height: 800
    });
    skinViewer.loadPanorama("https://skinview3d-demo.vercel.app/img/panorama.png");
    const res = await fetch(`https://api.capes.dev/load/${encodeURIComponent(name)}`);
    if (!res.ok) {
      throw new Error(`API error: ${res.status}`);
    }
  
    const data = await res.json();
    
    skinViewer.loadCape(data?.minecraft?.imageUrl || null);
    return;
  }
    ipcRenderer.send("get-players");
  ipcRenderer.on("players-list", (event, newPlayers) => { players = newPlayers; updateSKin(); });
  ipcRenderer.on("players-updated", (event, newPlayers) => { players = newPlayers; updateSKin(); });
function updatePresence(details, state = "Idle") {
  ipcRenderer.send('update-discord-presence', { details, state });
}

(async () => {
  const profile = await ipcRenderer.invoke("mc:getProfile");
  const skinsDiv = document.getElementById("skins");
  const capesDiv = document.getElementById("capes");

  // ---- Current skins ----
  profile.skins.forEach(skin => {
    const btn = document.createElement("button");
    btn.textContent = "Skin: " + (skin.alias || skin.id);
    btn.onclick = () => {
      ipcRenderer.invoke("mc:applySkin", skin)
        .catch(err => console.error("skin fail:", err));
    };
    skinsDiv.appendChild(btn);
  });

  // ---- Current capes ----
  profile.capes.forEach(cape => {
    const btn = document.createElement("button");
    btn.textContent = "Cape: " + (cape.alias || cape.id);
    btn.onclick = () => {
      ipcRenderer.invoke("mc:applyCape", cape.id)
        .catch(err => console.error("cape fail:", err));
    };
    capesDiv.appendChild(btn);
  });

  // ---- Previous skins from NameMC-like API ----
  try {
    const res = await fetch(`https://api.capes.dev/load/${profile.name}`);
    if (res.ok) {
      const previous = await res.json();
      if (previous?.skins) {
        previous.skins.forEach(skin => {
          // skip duplicates (already in current profile)
          if (!profile.skins.some(s => s.textureKey === skin.textureKey)) {
            const btn = document.createElement("button");
            btn.textContent = "Old Skin: " + (skin.alias || skin.id);
            btn.onclick = () => {
              ipcRenderer.invoke("mc:applySkin", skin)
                .catch(err => console.error("skin fail:", err));
            };
            skinsDiv.appendChild(btn);
          }
        });
      }
    }
  } catch (err) {
    console.warn("Failed to fetch previous skins:", err);
  }
})();


updatePresence("Managing skins")
</script>
  <script src="sidebar.js"></script>
  </div>
</body>
</html>
