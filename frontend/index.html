<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Redstone Launcher</title>
</head>
<body>
  <h1>Redstone Launcher</h1>

  <!-- ─────────────── Players Section ─────────────── -->
  <h2>Players</h2>
  <div>
    <label>
      Cracked username:
      <input id="crackedName" placeholder="Steve" />
    </label>
    <button id="createCrackedBtn">Add Cracked Player</button>
    <button id="loginMicrosoftBtn">Login Microsoft</button>
  </div>
  <ul id="players-list"></ul>

  <!-- ─────────────── Profiles Section ─────────────── -->
  <h2>Game Profiles</h2>
  <div>
    <label>
      Profile name:
      <input id="profileName" placeholder="Vanilla 1.20" />
    </label>
    <label>
      Version:
      <input id="profileVersion" value="1.20.1" />
    </label>
    <label>
      Player:
      <select id="playerSelect">
        <option value="">-- select player --</option>
      </select>
    </label>
    <button id="createProfileBtn">Create Game Profile</button>
  </div>
  <ul id="profiles-list"></ul>

  <h2>Logs</h2>
  <pre id="logs" style="height:200px; overflow:auto;"></pre>

  <script>
    const { ipcRenderer } = require("electron");

    document.addEventListener("DOMContentLoaded", () => {
      const crackedName = document.getElementById("crackedName");
      const createCrackedBtn = document.getElementById("createCrackedBtn");
      const loginMicrosoftBtn = document.getElementById("loginMicrosoftBtn");
      const playersList = document.getElementById("players-list");
      const playerSelect = document.getElementById("playerSelect");
      const profileName = document.getElementById("profileName");
      const profileVersion = document.getElementById("profileVersion");
      const createProfileBtn = document.getElementById("createProfileBtn");
      const profilesList = document.getElementById("profiles-list");
      const logs = document.getElementById("logs");

      // Buttons
      createCrackedBtn.addEventListener("click", () => {
        const name = crackedName.value.trim();
        if (!name) { alert("Enter a cracked username"); return; }
        ipcRenderer.send("create-cracked-player", name);
        crackedName.value = "";
      });

      loginMicrosoftBtn.addEventListener("click", () => {
        ipcRenderer.send("login-microsoft");
      });

      createProfileBtn.addEventListener("click", () => {
        const name = profileName.value.trim();
        const version = profileVersion.value.trim();
        const playerId = Number(playerSelect.value);
        if (!name || !version || !playerId) {
          alert("Fill profile name, version, and select a player");
          return;
        }
        ipcRenderer.send("create-profile", { name, version, playerId });
        profileName.value = "";
        profileVersion.value = "1.20.1";
      });

      // IPC handlers - Players
      ipcRenderer.on("players-list", (event, players) => {
        playersList.innerHTML = "";
        playerSelect.innerHTML = '<option value="">-- select player --</option>';
        players.forEach(p => {
          const li = document.createElement("li");
          const display = p.username ?? (p.auth?.selectedProfile?.name ?? "MS Account");
          li.textContent = `[${p.type}] ${display} (id: ${p.id})`;
          playersList.appendChild(li);

          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = `${p.id} — ${display} (${p.type})`;
          playerSelect.appendChild(opt);
        });
      });

      ipcRenderer.on("players-updated", (event, players) => {
        ipcRenderer.emit("players-list", null, players);
      });

      // IPC handlers - Profiles
      ipcRenderer.on("profiles-list", (event, profiles) => {
        profilesList.innerHTML = "";
        profiles.forEach(p => {
          const li = document.createElement("li");
          li.textContent = `${p.name} (v${p.version}, playerId=${p.playerId}) `;

          // Launch button
          const launchBtn = document.createElement("button");
          launchBtn.textContent = "Launch";
          launchBtn.onclick = () => ipcRenderer.send("launch-profile", p.id);
          li.appendChild(launchBtn);

          // Modloader install button
          const modBtn = document.createElement("button");
          modBtn.textContent = "Install Modloader";
          li.appendChild(modBtn);

          // Dropdown for modloader selection (hidden by default)
          const select = document.createElement("select");
          select.style.display = "none";
          ["Fabric","Quilt","Forge","NeoForge"].forEach(mod => {
            const opt = document.createElement("option");
            opt.value = mod.toLowerCase();
            opt.textContent = mod;
            select.appendChild(opt);
          });
          li.appendChild(select);

          // Confirm install button
          const confirmBtn = document.createElement("button");
          confirmBtn.textContent = "Install";
          confirmBtn.style.display = "none";
          li.appendChild(confirmBtn);

          // Button logic
          modBtn.onclick = () => {
            select.style.display = "inline";
            confirmBtn.style.display = "inline";
          };
          confirmBtn.onclick = () => {
            const mod = select.value;
            ipcRenderer.send("install-modloader", {
              type: mod,
              version: p.version,
              instanceId: p.id
            });
          };

          profilesList.appendChild(li);
        });
      });

      ipcRenderer.on("profiles-updated", (event, profiles) => {
        ipcRenderer.emit("profiles-list", null, profiles);
      });

      // Logs
      ipcRenderer.on("launcher-log", (event, msg) => {
        logs.textContent += msg + "\n";
        logs.scrollTop = logs.scrollHeight;
      });
      ipcRenderer.on("modloader-log", (event, msg) => {
        logs.textContent += "[MODLOADER] " + msg + "\n";
        logs.scrollTop = logs.scrollHeight;
      });
      ipcRenderer.on("modloader-done", (event, type) => {
        logs.textContent += `[MODLOADER] ${type} installed!\n`;
        logs.scrollTop = logs.scrollHeight;
      });
      ipcRenderer.on("modloader-error", (event, err) => {
        logs.textContent += "[MODLOADER ERROR] " + err + "\n";
        logs.scrollTop = logs.scrollHeight;
      });

      ipcRenderer.on("launch-error", (event, msg) => {
        logs.textContent += "[ERROR] " + msg + "\n";
        logs.scrollTop = logs.scrollHeight;
      });
      ipcRenderer.on("login-error", (event, msg) => {
        logs.textContent += "[LOGIN ERROR] " + msg + "\n";
        logs.scrollTop = logs.scrollHeight;
      });

      // initial load
      ipcRenderer.send("get-players");
      ipcRenderer.send("get-profiles");
    });
  </script>
</body>
</html>
