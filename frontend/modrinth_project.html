<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Project Details</title>
<link rel="stylesheet" href="modrinth.css" />
<link rel="stylesheet" href="server.css" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  .project-header {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    padding-right: 20px;
    margin-bottom: 20px;
    padding-top: 20px;
  }
  .project-header img {
    width: 96px;
    height: 96px;
    border-radius: var(--border-radius);
  }
  .project-header .info {
    flex: 1;
  }
  .project-header h1 {
    margin: 0;
    font-size: 1.8em;
  }
  .project-header p.summary {
    margin: 4px 0;
    font-size: 1em;
    opacity: 0.8;
  }
  .project-meta {
    display: flex;
    gap: 15px;
    opacity: 0.8;
  }
  .download-btn {
    background: var(--base-color);
    border: none;
    border-radius: var(--border-radius);
    color: var(--text-color);
    padding: 10px 15px;
    cursor: pointer;
    font-family: var(--text-font);
    transition: background 0.2s;
  }
  .download-btn:hover {
    background: var(--third-color);
  }
  .description {
    background: var(--very-dark);
    border-radius: var(--border-radius);
    padding: 15px;
    line-height: 1.5;
  }
</style>
</head>
<body>
    <div id="toolbar">
  <div class="toolbar-buttons-left">
      <button id="backBtn">⬅</button>
      <button id="forwardBtn">➡</button>
  </div>
<div class="drag-region">Redstone Launcher</div>
<div class="toolbar-buttons">
    <div id="instance-processes"></div>
    <button id="min-btn">—</button>
    <button id="max-btn">◻</button>
    <button id="close-btn">✕</button>
</div>
</div>
<div class="sidebar">
  <ul class="menu top">
    <a href="index.html"><li><i class="material-icons">home</i><span>Home</span></li></a>
    <a href="instances.html"><li><i class="material-icons">play_arrow</i><span>Instances</span></li></a>
    <a href="modrinth.html" class="modrinth"><li><span>Modrinth</span></li></a>
    <a href="server.html"><li><i class="material-icons">storage</i><span>Server Manager</span></li></a>
  </ul>
  <ul class="menu middle" id="instances">
    <li><i class="material-icons">add</i><span>Add an instance</span></li>
  </ul>
  <ul class="menu bottom">
    <li id="update"><i class="material-icons">download</i><span id="updateText">Download the latest update</span></li>
    <li><a href="profile-manager.html"><i class="material-icons">face</i></a><span>Skin, cape changer</span></li>
    <a href="players.html"><li id="players-login"><i class="material-icons">login</i><span>Login</span></li></a>
    <li><a href="settings.html"><i class="material-icons">settings</i></a><span>Settings</span></li>
  </ul>
</div>
  <div id="project-container" class="project-container">
    <div id="projectHeader" class="project-header"></div>
    <div id="projectDescription" class="description"></div>
  </div>

<script>
    const { ipcRenderer, shell } = require('electron');
const resultsList = document.getElementById('projectDescription');

let profiles = [];
let servers = [];

// Fetch profiles & servers
ipcRenderer.send('get-profiles');
ipcRenderer.on('profiles-list', (e, data) => profiles = data);

async function fetchServers() {
  servers = await ipcRenderer.invoke('list-servers');
}

function formatNumber(num) {
  if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
  if (num >= 1_000) return (num / 1_000).toFixed(1).replace(/\.0$/, "") + "K";
  return num.toString();
}

async function loadProjectDetails() {
  const shouldDostuff = localStorage.getItem("shouldDownload") || false;
  const mod = JSON.parse(localStorage.getItem("selectedModrinthProject"));
  if (!mod) {
    document.body.innerHTML = "<p>Project data missing</p>";
    return;
  }

  document.title = `${mod.title} - Modrinth`;

  const header = document.getElementById("projectHeader");
  let followers = mod.follows
  if (shouldDostuff) {
    const downloadBtn = document.getElementById("downloadProjectBtn");
    downloadBtn.style.display = "none";
    followers = mod.followers;
  }

  header.innerHTML = `
    <img src="${mod.icon_url || ''}" alt="Project Icon">
    <div class="info">
      <h1>${mod.title}</h1>
      <p class="summary">${mod.description}</p>
      <div class="project-meta">
        <span>${formatNumber(mod.downloads)} downloads</span>
        <span>${formatNumber(followers) || 0} followers</span>
        <span>by ${mod.author || 'Unknown'}</span>
      </div>
    </div>
    <button id="downloadProjectBtn" class="download-btn">Install</button>
  `;

  // Fetch long description
try {
    const res = await fetch(`https://api.modrinth.com/v2/project/${mod.project_id}`);
    const full = await res.json();
    const bodyHtml = full.body || full.description || "<p>No description available.</p>";

    // render markdown using marked if available, otherwise insert as plain text
    let html;
    if (window.marked) html = marked.parse(bodyHtml);
    else html = `<div>${bodyHtml}</div>`;

    const descEl = document.getElementById("projectDescription");
    descEl.innerHTML = html;
    descEl.classList.add("projectView-scrolly")

    // Make sure anchors open in the system browser
    descEl.querySelectorAll("a").forEach(a => {
      const href = a.getAttribute("href");
      if (!href) return;
      a.addEventListener("click", (ev) => {
        ev.preventDefault();
        shell.openExternal(href);
      });
      // set cursor visible as link
      a.style.cursor = "pointer";
    });

    // Download button behaviour — pick a reasonable file if present
    const downloadBtn = document.getElementById("downloadProjectBtn");
    downloadBtn.onclick = () => openInstallScreen(mod);
  } catch (err) {
    document.getElementById("projectDescription").innerText = "Failed to load project details.";
    console.error("Failed to fetch project details", err);
  }
}

async function openInstallScreen(mod) {
const shouldDostuff = localStorage.getItem("shouldDownload") || false;
const downloadBtn = document.getElementById("downloadProjectBtn");
if (shouldDostuff) {
  return downloadBtn.style.display = "none";
}
if (downloadBtn.textContent == "Back") {
    downloadBtn.textContent = "Install";
    loadProjectDetails();
    return;
} else {
    downloadBtn.textContent = "Back";
    const descEl = document.getElementById("projectDescription");
    descEl.classList.remove("projectView-scrolly")
}
  resultsList.innerHTML = `
    <h3 style="margin-bottom:10px;">Install ${mod.title}</h3>
    <div class="install-scroll-area" id="installArea"></div>
  `;
  const installArea = document.getElementById("installArea");


  const projType = mod.project_type?.toLowerCase();
  const selectedType = localStorage.getItem("modrinthSelectedType") || "mod";

  // --- Handle modpacks ---
  if (projType === "modpack") {
    let versions = [];
    try {
      const res = await fetch(`https://api.modrinth.com/v2/project/${mod.project_id}/version`);
      versions = await res.json();
    } catch (err) {
      console.error("Failed to fetch modpack versions:", err);
      installArea.innerHTML += "<p>Failed to fetch modpack versions</p>";
      return;
    }

    if (!Array.isArray(versions) || versions.length === 0) {
      installArea.innerHTML += "<p>No versions found for this modpack</p>";
      return;
    }

    versions.sort((a, b) => new Date(b.date_published) - new Date(a.date_published));

    const list = document.createElement("ul");
    list.className = "uli";

    versions.forEach(v => {
      const li = document.createElement("li");
      li.className = "profile-item";

      const info = document.createElement("div");
      info.className = "profile-info";

      const name = document.createElement("div");
      name.className = "profile-name";
      name.textContent = `${v.name}`;
      info.appendChild(name);

      const details = document.createElement("div");
      details.className = "profile-details";
      details.textContent = `Version: ${v.version_number}`;
      info.appendChild(details);

      li.appendChild(info);

      const installBtn = document.createElement("button");
      installBtn.textContent = "Install";
      installBtn.onclick = async () => {
        const mrpackFile = v.files.find(f => f.url.endsWith(".mrpack"));
        if (!mrpackFile) return alert("No .mrpack file available for this version");

        await ipcRenderer.invoke("install-mrpack-url", mrpackFile.url);
        alert(`Started installation of ${mod.title} (${v.version_number})`);
      };
      li.appendChild(installBtn);

      list.appendChild(li);
    });

    installArea.appendChild(list);
    return;
  }

  // --- Fetch versions ---
  let validVersions = [];
  try {
    const res = await fetch(`https://api.modrinth.com/v2/project/${mod.project_id}/version`);
    const allVersions = await res.json();
    validVersions = Array.isArray(allVersions) ? allVersions : [];
  } catch (err) {
    console.error("Failed to fetch mod versions:", err);
    installArea.innerHTML += "<p>Failed to fetch mod versions</p>";
    return;
  }

  function isCompatible(instanceVersion, loader) {
    return validVersions.some(v => {
      const loaderMap = v.loaders.map(l => (l === "vanilla" ? "vanilla" : l));
      return v.game_versions.includes(instanceVersion) && loaderMap.includes(loader);
    });
  }

  // --- CLIENT INSTANCES ---
  if (
    projType === "shader" ||
    projType === "resourcepack" ||
    (projType === "mod" && selectedType === "mod")
  ) {
    const clientHeader = document.createElement("h4");
    clientHeader.textContent = "Client Instances";
    installArea.appendChild(clientHeader);

    profiles.forEach(p => {
      if (projType === "shader") {
        if (!["fabric", "quilt", "forge", "neoforge"].includes(p.loader)) return;
        if (!validVersions.some(v => v.game_versions.includes(p.version))) return;
      } else if (projType === "mod" && selectedType === "mod") {
        if (!["fabric", "quilt", "forge", "neoforge"].includes(p.loader)) return;
        if (!isCompatible(p.version, p.loader)) return;
      }

      const li = document.createElement("li");
      li.className = "profile-item";

      const img = document.createElement("img");
      img.src = p.icon || "https://tggamesyt.dev/assets/redstone_launcher_defaulticon.png";
      li.appendChild(img);

      const info = document.createElement("div");
      info.className = "profile-info";

      const name = document.createElement("div");
      name.className = "profile-name";
      name.textContent = p.name;
      info.appendChild(name);

      const details = document.createElement("div");
      details.className = "profile-details";
      details.textContent = `v${p.version} • ${p.loader}`;
      info.appendChild(details);

      li.appendChild(info);

const installBtn = document.createElement("button");

(async () => {
  let exists = false;
  let fileUrl = null;

  // Loop through all versions
  for (const v of validVersions) {
    if (
      v.game_versions.includes(p.version) &&
      v.loaders.includes(p.loader === "vanilla" ? "vanilla" : p.loader)
    ) {
      // Loop through all files in this version
      for (const f of v.files || []) {
        fileUrl = f.url;
        if (!fileUrl) continue;

        const found = await ipcRenderer.invoke("check-file-exists", String(p.id), true, fileUrl);
        if (found) {
          exists = true;
          break; // Stop checking files if any exists
        }
      }
    }
    if (exists) break; // Stop checking versions if any exists
  }

  if (!fileUrl) {
    installBtn.textContent = "Unavailable";
    installBtn.disabled = true;
    return;
  }

  if (exists) {
    installBtn.textContent = "Installed";
    installBtn.disabled = true;
  } else {
    installBtn.textContent = "Install Here";
    installBtn.onclick = async () => {
      installBtn.textContent = "Installing...";
      installBtn.disabled = true;

      await ipcRenderer.invoke("mod-download", {
        server: false,
        id: p.id,
        fileUrl,
        projectType: selectedType
      });

      installBtn.textContent = "Installed";
    };
  }
})();


li.appendChild(installBtn);
installArea.appendChild(li);
    });
  }

  // --- SERVER INSTANCES ---
  await fetchServers();
  if (
    projType === "resourcepack" ||
    (projType === "shader" && false) ||
    (projType === "mod" && ["mod", "plugin", "datapack"].includes(selectedType))
  ) {
    const serverHeader = document.createElement("h4");
    serverHeader.textContent = "Servers";
    installArea.appendChild(serverHeader);

    servers.forEach(s => {
      const modded = ["fabric", "quilt", "forge", "neoforge"].includes(s.type);
      const pluginned = ["purpur", "paper"].includes(s.type);

      if (projType === "mod" && selectedType === "mod") {
        if (!modded) return;
      }
      if (projType === "mod" && selectedType === "plugin") {
        if (!mod.categories.includes("paper")) return;
        if (!pluginned) return;
      }
      if (projType === "mod" && selectedType === "datapack") {
        if (!mod.categories.includes("datapack")) return;
      }

      const matchedVersion = validVersions.find(v => v.game_versions.includes(s.version));
      if (!matchedVersion) return;

      const li = document.createElement("li");
      li.className = "profile-item";

      const img = document.createElement("img");
      img.src = s.icon || "https://tggamesyt.dev/assets/redstone_launcher_defaulticon.png";
      li.appendChild(img);

      const info = document.createElement("div");
      info.className = "profile-info";

      const name = document.createElement("div");
      name.className = "profile-name";
      name.textContent = s.name;
      info.appendChild(name);

      const details = document.createElement("div");
      details.className = "profile-details";
      details.textContent = `${s.type} • ${s.version}`;
      info.appendChild(details);

      li.appendChild(info);

      const installBtn = document.createElement("button");
      installBtn.textContent = "Install Here";
      installBtn.onclick = async () => {
        installBtn.textContent = "Installing...";
        installBtn.disabled = true;

        const fileUrl = matchedVersion.files[0]?.url;
        if (!fileUrl) return (installBtn.textContent = "Install failed");

        await ipcRenderer.invoke("mod-download", {
          server: true,
          id: s.name,
          fileUrl,
          projectType: selectedType
        });

        installBtn.textContent = "Installed";
      };
      li.appendChild(installBtn);

      installArea.appendChild(li);
    });
  }
}
loadProjectDetails();
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="sidebar.js"></script>
</body>
</html>
