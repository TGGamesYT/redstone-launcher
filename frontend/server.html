<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Redstone Launcher — Server Manager</title>
  <link rel="stylesheet" href="server.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    #serversList {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      max-height: calc(100vh - 140px);
      padding-right: 8px;
    }

    /* Modal */
    #createServerModal {
      display: none;
      position: fixed;
      padding: 1px;
      inset: 0;
      background: red;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal-content {
      background: var(--bg-color);
      color: var(--text-color);
      border-radius: var(--border-radius);
      padding: 20px;
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #consoleView {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #console {
      background: #111;
      color: #0f0;
      font-family: monospace;
      padding: 10px;
      border-radius: var(--border-radius);
      height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div id="toolbar">
  <div class="toolbar-buttons-left">
      <button id="backBtn">⬅</button>
      <button id="forwardBtn">➡</button>
  </div>
<div class="drag-region">Redstone Launcher</div>
<div class="toolbar-buttons">
    <div id="instance-processes"></div>
    <button id="min-btn">—</button>
    <button id="max-btn">◻</button>
    <button id="close-btn">✕</button>
</div>
</div>
<div class="sidebar">
  <ul class="menu top">
    <a href="index.html"><li><i class="material-icons">home</i><span>Home</span></li></a>
    <a href="instances.html"><li><i class="material-icons">play_arrow</i><span>Instances</span></li></a>
    <a href="modrinth.html" class="modrinth"><li><span>Modrinth</span></li></a>
    <a href="server.html"><li><i class="material-icons">storage</i><span>Server Manager</span></li></a>
  </ul>
  <ul class="menu middle" id="instances">
    <li><i class="material-icons">add</i><span>Add an instance</span></li>
  </ul>
  <ul class="menu bottom">
    <li id="update"><i class="material-icons">download</i><span id="updateText">Download the latest update</span></li>
    <li><a href="profile-manager.html"><i class="material-icons">face</i></a><span>Skin, cape changer</span></li>
    <a href="players.html"><li id="players-login"><i class="material-icons">login</i><span>Login</span></li></a>
    <li><a href="settings.html"><i class="material-icons">settings</i></a><span>Settings</span></li>
  </ul>
</div>
<div id="news-modal">
  <div id="news-modal-content">
    <span id="news-modal-close">&times;</span>
    <div id="news-modal-body"></div>
  </div>
</div>

  <div class="main">
    <div id="serverListView">
      <h2>Servers</h2>
      <ul id="serversList"></ul>
      <button id="openCreateModal" class="create-btn">+ Create Server</button>
    </div>

    <div id="consoleView">
      <h2 id="consoleTitle">Console</h2>
      <div id="console"></div>
      <div>
        <input id="cmdInput" placeholder="say hello" />
        <button id="sendCmdBtn">Send</button>
      </div>
      <div>
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <button id="restartBtn">Restart</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="createServerModal">
    <div class="modal-content">
      <h3>Create New Server</h3>
      <label>Server Name: <input id="srvName" placeholder="My Server" /></label>
      <label>Version: <input id="srvVersion" value="1.20.1" /></label>
      <label>Type:
        <select id="srvType">
          <option value="vanilla">Vanilla</option>
          <option value="paper">Paper</option>
          <option value="fabric">Fabric (server)</option>
        </select>
      </label>
      <div style="display:flex; gap:10px; justify-content:end;">
        <button id="cancelCreate">Cancel</button>
        <button id="createServerBtn">Create</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const serversList = document.getElementById('serversList');
    const openCreateModal = document.getElementById('openCreateModal');
    const createServerModal = document.getElementById('createServerModal');
    const createServerBtn = document.getElementById('createServerBtn');
    const cancelCreate = document.getElementById('cancelCreate');
    const srvName = document.getElementById('srvName');
    const srvVersion = document.getElementById('srvVersion');
    const srvType = document.getElementById('srvType');
    const consoleView = document.getElementById('consoleView');
    const serverListView = document.getElementById('serverListView');
    const consoleBox = document.getElementById('console');
    const cmdInput = document.getElementById('cmdInput');
    const sendCmdBtn = document.getElementById('sendCmdBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const restartBtn = document.getElementById('restartBtn');
    const consoleTitle = document.getElementById('consoleTitle');

    let servers = [];
    let selectedServer = null;

    openCreateModal.onclick = () => (createServerModal.style.display = "flex");
    cancelCreate.onclick = () => (createServerModal.style.display = "none");

    createServerBtn.onclick = async () => {
      const name = srvName.value.trim() || `Server-${Date.now()}`;
      const version = srvVersion.value.trim() || "1.20.1";
      const type = srvType.value;
      await ipcRenderer.invoke('make-server', { name, version, type });
      createServerModal.style.display = "none";
      await loadServers();
    };

    async function loadServers() {
      servers = await ipcRenderer.invoke('list-servers');
      renderServers();
    }

    function renderServers() {
      serversList.innerHTML = '';
      servers.forEach(p => {
        const li = document.createElement("li");
        li.className = "profile-item";

        const img = document.createElement("img");
        img.src = p.icon || "https://tggamesyt.dev/assets/redstone_launcher_defaulticon.png";
        li.appendChild(img);

        const info = document.createElement("div");
        info.className = "profile-info";

        const name = document.createElement("div");
        name.className = "profile-name";
        name.textContent = p.name;
        info.appendChild(name);

        const details = document.createElement("div");
        details.className = "profile-details";
        details.textContent = `v${p.version} • ${p.type}`;
        info.appendChild(details);

        li.appendChild(info);

        const openFolderBtn = document.createElement("button");
        openFolderBtn.textContent = "Open Folder";
        openFolderBtn.onclick = (e) => {
          e.stopPropagation();
          ipcRenderer.send("open-folder", { id: p.name, isClient: false });
        };
        li.appendChild(openFolderBtn);

        const launchBtn = document.createElement("button");
        launchBtn.className = "play-button";
        launchBtn.innerHTML = `<i class="material-icons">terminal</i>`;
        launchBtn.onclick = (e) => {
          e.stopPropagation();
          openConsoleView(p);
        };
        li.appendChild(launchBtn);

        li.onclick = () => openConsoleView(p);
        serversList.appendChild(li);
      });
    }

    function openConsoleView(server) {
      selectedServer = server;
      consoleTitle.textContent = `Console — ${server.name}`;
      serverListView.style.display = "none";
      consoleView.style.display = "flex";
      pollConsole();
    }

    async function pollConsole() {
      if (!selectedServer) return;
      const content = await ipcRenderer.invoke('server-console', selectedServer.name);
      consoleBox.textContent = Array.isArray(content) ? content.join('') : content;
      consoleBox.scrollTop = consoleBox.scrollHeight;
      setTimeout(pollConsole, 1000);
    }

    sendCmdBtn.onclick = async () => {
      if (!selectedServer) return;
      const cmd = cmdInput.value.trim();
      if (!cmd) return;
      await ipcRenderer.invoke('send-server-command', selectedServer.name, cmd);
      cmdInput.value = '';
    };

    startBtn.onclick = () => ipcRenderer.invoke('start-server', selectedServer.name);
    stopBtn.onclick = () => ipcRenderer.invoke('stop-server', selectedServer.name);
    restartBtn.onclick = () => ipcRenderer.invoke('restart-server', selectedServer.name);

    loadServers();
  </script>
  <script src="sidebar.js"></script>
</body>
</html>
