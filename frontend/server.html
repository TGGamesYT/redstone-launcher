<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Redstone Launcher â€” Server Manager</title>
  <link rel="stylesheet" href="server.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    #serversList {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      max-height: calc(100vh - 140px);
      padding-right: 8px;
    }

    /* Modal */
    #createServerModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                 background: rgba(0,0,0,0.5); justify-content: center; align-items: center; 
    }

    .modal-content {
      background: var(--third-color); 
      padding: 20px;
      color: var(--text-color);
      border-radius: var(--border-radius);
      padding: 20px;
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #consoleView {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #console {
      background: #111;
      color: #0f0;
      font-family: monospace;
      padding: 10px;
      border-radius: var(--border-radius);
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap; /* ðŸ‘ˆ This is the key! */
    }
    .promain {
      display: flex;
    }
    #serverListView {
  flex: 2;              /* 2 parts */
  padding: 20px;
  overflow-y: auto;
}

/* Right panel */
#proxysidebar {
  flex: 1;              /* 1 part â†’ 1/3 of space */
  padding: 20px;
  overflow-y: auto;
}
  </style>
</head>
<body>
<div id="toolbar">
  <div class="toolbar-buttons-left">
      <button id="backBtn">â¬…</button>
      <button id="forwardBtn">âž¡</button>
  </div>
<div class="drag-region">Redstone Launcher</div>
<div class="toolbar-buttons">
    <div id="instance-processes"></div>
    <button id="min-btn">â€”</button>
    <button id="max-btn">â—»</button>
    <button id="close-btn">âœ•</button>
</div>
</div>
<div class="sidebar">
  <ul class="menu top">
    <a href="index.html"><li><i class="material-icons">home</i><span>Home</span></li></a>
    <a href="instances.html"><li><i class="material-icons">play_arrow</i><span>Instances</span></li></a>
    <a href="modrinth.html" class="modrinth"><li>î’²<span>Modrinth</span></li></a>
    <a href="server.html"><li><i class="material-icons">storage</i><span>Server Manager</span></li></a>
  </ul>
  <ul class="menu middle" id="instances">
    <li><i class="material-icons">add</i><span>Add an instance</span></li>
  </ul>
  <ul class="menu bottom">
    <li id="update"><i class="material-icons">download</i><span id="updateText">Download the latest update</span></li>
    <li><a href="profile-manager.html"><i class="material-icons">face</i></a><span>Skin, cape changer</span></li>
    <a href="players.html"><li id="players-login"><i class="material-icons">login</i><span>Login</span></li></a>
    <li><a href="settings.html"><i class="material-icons">settings</i></a><span>Settings</span></li>
  </ul>
</div>

  <div class="promain" style="padding-top: 1px;">
    <div id="serverListView">
      <h2>Servers</h2>
      <ul id="serversList"></ul>
      <button id="openCreateModal" class="create-btn">+ Create Server</button>
    </div>

    <div id="proxysidebar">
      <div>
        <button  onclick="() => {document.getElementById('proxypart').style.display = 'block'; document.getElementById('newproxypart').style.display = 'none'; document.getElementById('loginpart').style.display = 'none';}">Proxies</button>
        <button   onclick="() => {document.getElementById('proxypart').style.display = 'none'; document.getElementById('newproxypart').style.display = 'none'; document.getElementById('loginpart').style.display = 'block';}">Log in</button>
      </div>
      <div id="proxypart">
        <h1>Proxies</h1>
        <button onclick="() => {document.getElementById('proxypart').style.display = 'none'; document.getElementById('newproxypart').style.display = 'block';}">create new proxy</button>
        <ul id="proxies"></ul>
      </div>
      <div id="loginpart" style="display:none;">
        <h1>Log in</h1>
        Logged in as <span id="loggedinas"></span><br>
        <button id="deleteaccount">Delete Account</button><br>
        <input type="text" id="username" placeholder="username"><br>
        <input type="text" id="password" placeholder="password"><br>
        <button id="loginbutton">log in</button>
      </div>
      <div id="newproxypart" style="display:none;">
        <h1>Create new proxy</h1>
        <input type="text" id="proxyid" placeholder="proserver"><br>
        <input type="text" id="port" placeholder="port"><br>
        Use domain: <input type="checkbox" id="domain"><br>
        <button id="createproxy">create</button>
      </div>
    </div>

    <div id="consoleView">
      <h2 id="consoleTitle">Console</h2>
      <div id="console"></div>
      <div>
        <input id="cmdInput" placeholder="say hello" />
        <button id="sendCmdBtn">Send</button>
      </div>
      <div>
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <button id="restartBtn">Restart</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="createServerModal">
    <div class="modal-content">
      <h3>Create New Server</h3>
      <label>Server Name: <input id="srvName" placeholder="My Server" /></label>
      <label>Version: <select id="srvVersion"></select><input type="checkbox" id="showAllVersions" style="transform: scale(1.5); transform-origin: center;" /></label>
      <label>Type:
        <select id="srvType">
          <option value="vanilla">Vanilla</option>
          <option value="paper">Paper</option>
          <option value="fabric">Fabric (server)</option>
        </select>
      </label>
      <div style="display:flex; gap:10px; justify-content:end;">
        <button id="cancelCreate">Cancel</button>
        <button id="createServerBtn">Create</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const serversList = document.getElementById('serversList');
    const openCreateModal = document.getElementById('openCreateModal');
    const createServerModal = document.getElementById('createServerModal');
    const createServerBtn = document.getElementById('createServerBtn');
    const cancelCreate = document.getElementById('cancelCreate');
    const srvName = document.getElementById('srvName');
    const srvVersion = document.getElementById('srvVersion');
    const srvType = document.getElementById('srvType');
    const consoleView = document.getElementById('consoleView');
    const serverListView = document.getElementById('serverListView');
    const consoleBox = document.getElementById('console');
    const cmdInput = document.getElementById('cmdInput');
    const sendCmdBtn = document.getElementById('sendCmdBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const restartBtn = document.getElementById('restartBtn');
    const consoleTitle = document.getElementById('consoleTitle');

    let servers = [];
    let selectedServer = null;

    openCreateModal.onclick = () => (createServerModal.style.display = "flex");
    cancelCreate.onclick = () => (createServerModal.style.display = "none");

    createServerBtn.onclick = async () => {
      const name = srvName.value.trim() || `Server-${Date.now()}`;
      const version = srvVersion.value.trim() || "1.20.1";
      const type = srvType.value;
      await ipcRenderer.invoke('make-server', { name, version, type });
      createServerModal.style.display = "none";
      await loadServers();
    };

    async function loadServers() {
      servers = await ipcRenderer.invoke('list-servers');
      renderServers();
    }

    function renderServers() {
      serversList.innerHTML = '';
      servers.forEach(p => {
        const li = document.createElement("li");
        li.className = "profile-item";

        const img = document.createElement("img");
        img.src = p.icon || "https://tggamesyt.dev/assets/redstone_launcher_defaulticon.png";
        li.appendChild(img);

        const info = document.createElement("div");
        info.className = "profile-info";

        const name = document.createElement("div");
        name.className = "profile-name";
        name.textContent = p.name;
        info.appendChild(name);

        const details = document.createElement("div");
        details.className = "profile-details";
        details.textContent = `v${p.version} â€¢ ${p.type}`;
        info.appendChild(details);

        li.appendChild(info);

        const openFolderBtn = document.createElement("button");
        openFolderBtn.textContent = "Open Folder";
        openFolderBtn.onclick = (e) => {
          e.stopPropagation();
          ipcRenderer.send("open-folder", { id: p.name, isClient: false });
        };
        li.appendChild(openFolderBtn);

        const launchBtn = document.createElement("button");
        launchBtn.className = "play-button";
        launchBtn.innerHTML = `<i class="material-icons">terminal</i>`;
        launchBtn.onclick = (e) => {
          e.stopPropagation();
          openConsoleView(p);
        };
        li.appendChild(launchBtn);

        li.onclick = () => openConsoleView(p);
        serversList.appendChild(li);
      });
    }

    function openConsoleView(server) {
      document.getElementById('proxysidebar').style.display = 'none';
      selectedServer = server;
      consoleTitle.textContent = `Console â€” ${server.name}`;
      serverListView.style.display = "none";
      consoleView.style.display = "flex";
      pollConsole();
    }

    async function pollConsole() {
      if (!selectedServer) return;
      const content = await ipcRenderer.invoke('server-console', selectedServer.name);
      console.log(content)
      consoleBox.textContent = Array.isArray(content) ? content.join('') : content;
      consoleBox.scrollTop = consoleBox.scrollHeight;
      setTimeout(pollConsole, 1000);
    }

    sendCmdBtn.onclick = async () => {
      if (!selectedServer) return;
      const cmd = cmdInput.value.trim();
      if (!cmd) return;
      await ipcRenderer.invoke('send-server-command', selectedServer.name, cmd);
      cmdInput.value = '';
    };

    startBtn.onclick = () => ipcRenderer.invoke('start-server', selectedServer.name);
    stopBtn.onclick = () => ipcRenderer.invoke('stop-server', selectedServer.name);
    restartBtn.onclick = () => ipcRenderer.invoke('restart-server', selectedServer.name);
async function fetchVersions() {
  const response = await fetch('https://piston-meta.mojang.com/mc/game/version_manifest_v2.json');
  const data = await response.json();
  return data.versions; // array of {id, type, url, ...}
}
function populateSelect(versions, showAll) {
  const select = document.getElementById('srvVersion');
  select.innerHTML = ''; // clear existing options

  const filtered = showAll ? versions : versions.filter(v => v.type === 'release');

  filtered.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.id;
    opt.textContent = v.id;
    select.appendChild(opt);
  });

  // optionally select latest release by default
  if (!showAll) {
    const latest = filtered.find(v => v.type === 'release');
    if (latest) select.value = latest.id;
  }
}
async function initVersionSelect() {
  const versions = await fetchVersions();
  const checkbox = document.getElementById('showAllVersions');

  // initial populate (release only)
  populateSelect(versions, false);

  // update select when toggle changes
  checkbox.addEventListener('change', () => {
    populateSelect(versions, checkbox.checked);
  });
}
initVersionSelect();
    loadServers();

async function updateLoginInfo() {
  const user = await ipcRenderer.invoke("frpc:getCreds");
  if (user?.username) {
    $("loggedinas").textContent = user.username;
    $("username").style.display = "none";
    $("password").style.display = "none";
    $("loginbutton").style.display = "none";
  } else {
    $("username").style.display = "block";
    $("password").style.display = "block";
    $("loginbutton").style.display = "block";
  }
}

    const $ = (id) => document.getElementById(id);

/* ---------------------------------------------------
   PANEL SWITCH
--------------------------------------------------- */
function show(id) {
  $("proxypart").style.display = "none";
  $("loginpart").style.display = "none";
  $("newproxypart").style.display = "none";
  $(id).style.display = "block";
}

/* ---------------------------------------------------
   LOGIN
--------------------------------------------------- */
async function loginHandler() {
  const username = $("username").value;
  const password = $("password").value;

  const res = await ipcRenderer.invoke("frpc:login", username, password);
  if (res?.ok) {
    await refreshProxyList();
    show("proxypart");
    await updateLoginInfo();
  }
}

/* ---------------------------------------------------
   CREATE NEW PROXY
--------------------------------------------------- */
let domain = false;
document.getElementById('domain').addEventListener("change", e => {
    domain = e.target.checked;
  });

async function createProxyHandler() {
  const identifier = $("proxyid").value;
  const localport = Number($("port").value);
  console.log(domain)
  const params = {
    identifier,
    localport,
    hasdomain: domain,
    subdomain: identifier
  };

  const res = await ipcRenderer.invoke("frpc:createTunnel", params);

  if (res?.ok) {
    await refreshProxyList();
    show("proxypart");
    await updateLoginInfo();
  }
}

/* ---------------------------------------------------
   LIST PROXIES (Updated with Start/Stop)
--------------------------------------------------- */
async function refreshProxyList() {
  const res = await ipcRenderer.invoke("frpc:listTunnels");
  const running = await ipcRenderer.invoke("frpc:listRunningTunnels");
  const ul = $("proxies");
  ul.innerHTML = "";

  if (!res || !res.tunnels) return;

  for (const t of res.tunnels) {
    const li = document.createElement("li");
    li.className = "proxy-item";

    const remotePort = t.publicip?.split(":")[1] || "???";
    const isRunning = running.includes(t.identifier);

    li.innerHTML = `
      <span>${t.identifier} | localhost:${t.local_port} â†’ ${t.hasdomain ? t.publicdomain : t.publicip}</span><br>
      <button class="toggle">${isRunning ? "Stop" : "Start"}</button>
      <button class="delete">Delete</button>
    `;

    // Start / Stop tunnel
    li.querySelector(".toggle").addEventListener("click", async (e) => {
      if (isRunning) {
        await ipcRenderer.invoke("frpc:stopTunnel", t.identifier);
      } else {
        await ipcRenderer.invoke("frpc:connectTunnel", t.identifier);
      }
      await refreshProxyList(); // refresh buttons and list
    });

    // Delete tunnel
    li.querySelector(".delete").addEventListener("click", async () => {
      await ipcRenderer.invoke("frpc:deleteTunnel", t.identifier);
      await refreshProxyList();
    });

    ul.appendChild(li);
  }
}


/* ---------------------------------------------------
   EVENT BINDINGS (Fixing your broken inline onclick)
--------------------------------------------------- */

// Sidebar
document.querySelectorAll("#proxysidebar button").forEach(btn => {
  btn.addEventListener("click", (e) => {
    const t = e.target.innerText.trim().toLowerCase();
    if (t === "proxies") show("proxypart");
    if (t === "log in") show("loginpart");
  });
});

// Login button
$("loginbutton").addEventListener("click", loginHandler);

// Create new proxy button
$("createproxy").addEventListener("click", createProxyHandler);
//delete button
$("deleteaccount").addEventListener("click", async () => {
  await ipcRenderer.invoke("frpc:deleteAccount");
  await updateLoginInfo();
  show("loginpart");
});

// Inside proxy menu â†’ show creation
document.querySelector("#proxypart button")?.addEventListener("click", () => {
  show("newproxypart");
});

/* ---------------------------------------------------
   INITIAL LOAD
--------------------------------------------------- */
(async () => {
  const res = await ipcRenderer.invoke("frpc:listTunnels");
  if (res?.ok) {
    await updateLoginInfo();
    await refreshProxyList();
    show("proxypart");
  } else {
    show("loginpart");
  }
})();


  </script>
  <script src="sidebar.js"></script>
</body>
</html>
