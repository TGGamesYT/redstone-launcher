<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Redstone Launcher - Modrinth Browser</title>
<style>
  select, button { margin: 5px; padding: 5px; }
  .uli { list-style: none; padding: 0; }
  .lii { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .imagy { width: 32px; height: 32px; border-radius: 4px; }
</style>
 <link rel="stylesheet" href="server.css" />
 <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<div id="toolbar">
<div class="drag-region">Redstone Launcher - Modrinth Browser</div>
<div class="toolbar-buttons">
    <button id="min-btn">—</button>
    <button id="max-btn">□</button>
    <button id="close-btn">✕</button>
</div>
</div>
<div class="sidebar">
  <!-- Top section -->
  <ul class="menu top">
    <li><a href="index.html"><i class="material-icons">home</i></a><span>Home</span></li>
    <li><a href="instances.html"><i class="material-icons">play_arrow</i></a><span>Play</span></li>
    <li><a href="modrinth.html"><img src="https://tggamesyt.dev/assets/modrinth_icon.png" style="width: 24px;"></a><span>Modrinth</span></li>
    <li><a href="server.html"><i class="material-icons">storage</i></a><span>Server Manager</span></li>
    <li><a href="settings.html"><i class="material-icons">settings</i></a><span>Settings</span></li>
    <li><a href="players.html"><i class="material-icons">person</i></a><span>Profiles</span></li>
    <li><a href="profile-manager.html"><i class="material-icons">face</i></a><span>Skin, cape changer</span></li>
  </ul>

  <!-- Middle section (instances) -->
  <ul class="menu middle" id="instances">
    <li><i class="material-icons">add</i><span>Add an instance</span></li>
  </ul>

  <!-- Bottom section -->
  <ul class="menu bottom">
    <li><i class="material-icons">download</i><span>Download the latest update</span></li>
    <li id="players-login"><a href="players.html"><i class="material-icons">login</i></a><span>Login</span></li>
    <li><i class="material-icons" onclick="closeApp()">exit_to_app</i><span>Exit the launcher</span></li>
  </ul>
</div>

<div>
  <select id="projectType">
    <option value="mod">Mod</option>
    <option value="resourcepack">Resourcepack</option>
    <option value="datapack">Datapack</option>
    <option value="shader">Shader</option>
    <option value="modpack">Modpack</option>
    <option value="plugin">Plugin</option>
  </select>
  <button id="refreshBtn">Refresh</button>
</div>

<h3>Projects</h3>
<ul id="modrinthResults"></ul>

<script>
const { ipcRenderer } = require('electron');
const typeSelect = document.getElementById('projectType');
const refreshBtn = document.getElementById('refreshBtn');
const resultsList = document.getElementById('modrinthResults');

let profiles = [];
let servers = [];

// Fetch profiles & servers
ipcRenderer.send('get-profiles');
ipcRenderer.on('profiles-list', (e, data) => profiles = data);

async function fetchServers() {
  servers = await ipcRenderer.invoke('list-servers');
}

// Fetch top 20 projects from Modrinth
async function fetchProjects(type) {
  resultsList.innerHTML = 'Loading...';
  try {
    const url = `https://api.modrinth.com/v2/search?facets=[["project_type:${type}"]]&limit=20`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const data = await res.json();
    return data.hits || [];
  } catch(err) {
    console.error(err);
    resultsList.innerHTML = 'Failed to load projects';
    return [];
  }
}

// Render top projects
function renderProjects(projects) {
  resultsList.innerHTML = '';
  projects.forEach(mod => {
    const li = document.createElement('li');

    const img = document.createElement('img');
    img.src = mod.icon_url || '';
    img.className = "imagy"
    li.appendChild(img);

    const span = document.createElement('span');
    span.textContent = `${mod.title} (${mod.project_type})`;
    li.appendChild(span);

    const installBtn = document.createElement('button');
    installBtn.textContent = 'Install';
    installBtn.onclick = () => openInstallScreen(mod);
    li.appendChild(installBtn);

    resultsList.appendChild(li);
  });
}

// Show install screen with compatible instances/servers
async function openInstallScreen(mod) {
  resultsList.innerHTML = `<h3>Install ${mod.title}</h3>`;

  // Determine what is supported
  const isClientOnly = ['mod', 'modpack', 'shader'].includes(mod.project_type);
  const isServerOnly = ['datapack', 'plugin'].includes(mod.project_type);
  const both = mod.project_type === 'resourcepack';

  if (!isClientOnly && !isServerOnly && !both) {
    resultsList.innerHTML += '<p>Unsupported type</p>';
    return;
  }

  // Fetch mod versions from Modrinth
  let validVersions = [];
  try {
    const res = await fetch(`https://api.modrinth.com/v2/project/${mod.project_id}/version`);
    const allVersions = await res.json();
    validVersions = Array.isArray(allVersions) ? allVersions : [];
  } catch (err) {
    console.error("Failed to fetch mod versions:", err);
    resultsList.innerHTML += '<p>Failed to fetch mod versions</p>';
    return;
  }

  // Helper to check compatibility
  function isCompatible(instanceVersion, loader) {
    return validVersions.some(v => {
      const loaderMap = v.loaders.map(l => l === 'vanilla' ? 'vanilla' : l);
      return v.game_versions.includes(instanceVersion) && loaderMap.includes(loader);
    });
  }

  // Client instances
  if (isClientOnly || both) {
    const clientHeader = document.createElement('h4');
    clientHeader.textContent = 'Client Instances';
    resultsList.appendChild(clientHeader);

    const clientList = document.createElement('ul');
    clientList.className = "uli"
    profiles.forEach(p => {
      // Skip incompatible loaders
      if ((mod.project_type === 'mod' || mod.project_type === 'shader') && p.loader === 'vanilla') return;
      if (!isCompatible(p.version, p.loader)) return;

      const li = document.createElement('li');
      li.className = "lii"
      li.textContent = `${p.name} (${p.loader}, ${p.version})`;

      const btn = document.createElement('button');
      btn.textContent = 'Install here';
      btn.onclick = async () => {
        // Pick the latest compatible version's file
        const matchedVersion = validVersions.find(v =>
          v.game_versions.includes(p.version) &&
          v.loaders.includes(p.loader === 'vanilla' ? 'vanilla' : p.loader)
        );
        if (!matchedVersion) return alert(`No compatible version found for ${p.name}`);
        const fileUrl = matchedVersion.files[0]?.url;
        if (!fileUrl) return alert("No download file available for this version");

        await ipcRenderer.invoke('mod-download', {
          instanceId: p.id,
          fileUrl,
          projectType: mod.project_type
        });
        alert(`Installed ${mod.title} to ${p.name}`);
      };
      li.appendChild(btn);
      clientList.appendChild(li);
    });
    resultsList.appendChild(clientList);
  }

  // Server instances
  if (isServerOnly || both) {
    const serverHeader = document.createElement('h4');
    serverHeader.textContent = 'Servers';
    resultsList.appendChild(serverHeader);

    const serverList = document.createElement('ul');
    servers.forEach(s => {
      if (mod.project_type === 'plugin' && s.type !== 'paper') return;
      if (mod.project_type === 'datapack' && s.type !== 'paper' && s.type !== 'vanilla') return;

      // Check server version compatibility
      const matchedVersion = validVersions.find(v => v.game_versions.includes(s.version));
      if (!matchedVersion) return;

      const li = document.createElement('li');
      li.textContent = `${s.name} (${s.type}, ${s.status}, ${s.version})`;

      const btn = document.createElement('button');
      btn.textContent = 'Install here';
      btn.onclick = async () => {
        const fileUrl = matchedVersion.files[0]?.url;
        if (!fileUrl) return alert("No download file available for this version");

        await ipcRenderer.invoke('mod-download', {
          serverName: s.name,
          fileUrl,
          projectType: mod.project_type
        });
        alert(`Installed ${mod.title} to ${s.name}`);
      };
      li.appendChild(btn);
      serverList.appendChild(li);
    });
    resultsList.appendChild(serverList);
  }
}


// Load top projects
async function loadTopProjects() {
  const type = typeSelect.value;
  const projects = await fetchProjects(type);
  renderProjects(projects);
}

typeSelect.onchange = loadTopProjects;
refreshBtn.onclick = loadTopProjects;
loadTopProjects();

</script>
<script src="sidebar.js"></script>
</body>
</html>
